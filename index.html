<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch√∫c M·ª´ng Sinh Nh·∫≠t Ho√†ng Th·ªã Ki·ªÅu Trang!</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Pacifico&display=swap");
      body {
        font-family: "Be Vietnam Pro", sans-serif;
      }
      .countdown-bg {
        background-color: #f0f4f8;
        background-image: radial-gradient(
            circle at 15% 50%,
            #e6f0ff 0%,
            transparent 50%
          ),
          radial-gradient(circle at 85% 50%, #fff0e6 0%, transparent 50%);
        background-size: 200% 200%;
        animation: background-shift 10s ease-in-out infinite alternate;
      }
      @keyframes background-shift {
        0% {
          background-position: 0% 50%, 100% 50%;
        }
        100% {
          background-position: 100% 50%, 0% 50%;
        }
      }
      .balloon {
        position: absolute;
        bottom: -100px;
        border-radius: 50%;
        z-index: 0;
      }
      @keyframes balloon-float {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 0;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          transform: translateY(-120vh) rotate(360deg);
          opacity: 0;
        }
      }
      .confetti {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        opacity: 0;
        z-index: 20;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-100vh) rotateZ(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotateZ(720deg);
          opacity: 0.7;
        }
      }
      @keyframes pulse-glow {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(72, 202, 228, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 10px 5px rgba(72, 202, 228, 0.9);
        }
      }
      @keyframes floating {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .fade-in-down {
        animation: fade-in-down 1s ease-out;
      }
      .fade-in-up {
        animation: fade-in-up 1s ease-out;
      }
      @keyframes fade-in-down {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fade-in-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="bg-[#f5f5f5] min-h-screen">
    <!-- Countdown Section -->
    <div
      id="countdown-section"
      class="relative flex items-center justify-center min-h-screen p-4 font-sans text-[#0b3b42] overflow-hidden countdown-bg"
    >
      <div
        class="text-center p-8 bg-white rounded-3xl shadow-2xl max-w-lg w-full transform transition-all duration-500 ease-in-out hover:scale-105 relative z-10"
      >
        <div class="absolute top-[-20px] left-1/2 transform -translate-x-1/2">
          <svg
            class="w-12 h-12 text-[#f9ada0] animate-floating"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M20 9.5a2.5 2.5 0 0 0-2.5-2.5h-11A2.5 2.5 0 0 0 4 9.5v10a2.5 2.5 0 0 0 2.5 2.5h11a2.5 2.5 0 0 0 2.5-2.5zM12 2a2 2 0 0 1 2 2v2H10V4a2 2 0 0 1 2-2zM9 9h6a1 1 0 0 1 0 2H9a1 1 0 0 1 0-2zM4 14.5a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V15a.5.5 0 0 1 .5-.5zM20 15a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V15a.5.5 0 0 1 .5-.5z"
            />
          </svg>
        </div>
        <h1
          class="text-3xl md:text-4xl font-bold text-[#006d77] mb-4 relative z-10"
        >
          M·ªôt b·∫•t ng·ªù ƒëang ch·ªù...
        </h1>
        <p
          class="text-lg md:text-xl font-light italic mb-8 text-gray-600 relative z-10"
        >
          H√£y c√πng ƒë·∫øm ng∆∞·ª£c ƒë·∫øn kho·∫£nh kh·∫Øc ƒë·∫∑c bi·ªát nh√©!
        </p>
        <div
          id="countdown-container"
          class="grid grid-cols-2 sm:grid-cols-4 gap-4 md:gap-6 text-center"
        >
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="days"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Ng√†y
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="hours"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Gi·ªù
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="minutes"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Ph√∫t
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="seconds"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Gi√¢y
            </p>
          </div>
        </div>
        <p class="mt-8 text-sm md:text-md text-gray-500 italic relative z-10">
          G·ª£i √Ω: H√£y quay l·∫°i ƒë√∫ng 09:09 ng√†y 09/09/2025 ƒë·ªÉ kh√°m ph√°!
        </p>
      </div>
    </div>

    <!-- Birthday Content Section (hidden initially) -->
    <div
      id="birthday-content-section"
      class="relative min-h-screen font-sans text-[#0b3b42] overflow-hidden"
      style="display: none"
    >
      <div id="balloons-container"></div>
      <div id="confetti-container"></div>

      <div class="relative z-10 p-4 md:p-8 lg:p-12">
        <header class="text-center mb-10 md:mb-16">
          <h1
            class="text-4xl md:text-6xl font-bold text-[#006d77] leading-tight animate-fade-in-down"
          >
            Ch√∫c m·ª´ng sinh nh·∫≠t,<br />T√™r√™sa Ho√†ng Th·ªã Ki·ªÅu Trang!
          </h1>
          <p
            class="text-lg md:text-xl mt-2 italic text-[#83c5be] font-light animate-fade-in-up"
          >
            2002 - 09/09 - 2025
          </p>
          <div class="flex justify-center items-center my-6 animate-fade-in-up">
            <img
              src="./assets/images/170cc1c4-0d04-4637-b98c-7e063ab187c0.jpg"
              alt="·∫¢nh ƒë·∫°i di·ªán c·ªßa T√™r√™sa"
              class="w-40 h-40 rounded-full object-cover shadow-xl border-4 border-white transform transition-transform duration-300 hover:scale-110"
            />
          </div>
          <div class="mt-6">
            <p class="text-3xl font-bold text-[#48cae4]">
              Tu·ªïi 18+ r·∫°ng r·ª° v√† m√£i t∆∞∆°i vui!
            </p>
          </div>
          <button
            id="play-button"
            class="mt-6 p-4 rounded-full bg-[#48cae4] text-white shadow-lg transition-transform duration-300 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-[#48cae4] focus:ring-opacity-50"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              class="w-6 h-6"
            >
              <path d="M3 22v-20l18 10-18 10z" />
            </svg>
          </button>
          <audio
            id="background-music"
            src="./assets/audios/videoplayback.m4a"
            loop
          ></audio>
        </header>

        <section
          id="message-container"
          class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto mb-10 md:mb-16 border-l-4 border-[#f9ada0]"
        >
          <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-[#0b3b42]">
            G·ª≠i c√¥ b·∫°n th√¢n m·∫øn c·ªßa t√¥i...
          </h2>
          <div id="birthday-message">
            <p class="mb-4 text-gray-700 leading-relaxed">
              Ch√∫c m·ª´ng sinh nh·∫≠t, c√¥ b·∫°n b√°nh b√®o nh∆∞ng gi√†u t√¨nh c·∫£m c·ªßa t√¥i!
              H√¥m nay l√† m·ªôt ng√†y th·∫≠t ƒë·∫∑c bi·ªát, ng√†y m√† Ch√∫a ƒë√£ ban cho th·∫ø
              gi·ªõi m·ªôt ng∆∞·ªùi b·∫°n tuy·ªát v·ªùi nh∆∞ b·∫°n. D√π l√† b·∫°n b√®, t√¥i c≈©ng mu·ªën
              g·ª≠i ƒë·∫øn b·∫°n nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t cho m·ªôt trang m·ªõi c·ªßa cu·ªôc
              ƒë·ªùi. Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi tr√†n ng·∫≠p ni·ªÅm vui, ti·∫øng c∆∞·ªùi v√† nh·ªØng
              tr·∫£i nghi·ªám th·∫≠t ƒë√°ng nh·ªõ.
            </p>
            <p class="mb-4 text-gray-700 leading-relaxed">
              Ch√∫c b·∫°n lu√¥n tr√†n ƒë·∫ßy s·ª©c kh·ªèe, ƒë·ªÉ ti·∫øp t·ª•c cu·ªôc h√†nh tr√¨nh s·ªëng
              ƒë·ªông v√† ƒë·∫ßy √Ω nghƒ©a c·ªßa m√¨nh. Nguy·ªán xin Ch√∫a lu√¥n g√¨n gi·ªØ, che
              ch·ªü v√† soi s√°ng cho b·∫°n trong m·ªçi quy·∫øt ƒë·ªãnh, ƒë·ªÉ m·ªçi c√¥ng vi·ªác b·∫°n
              l√†m ƒë·ªÅu ƒë∆∞·ª£c h·ªìng √¢n c·ªßa Ng√†i.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "V√¨ Ta bi·∫øt r√µ nh·ªØng ch∆∞∆°ng tr√¨nh Ta d√†nh cho c√°c con, ƒë√≥ l√†
              ch∆∞∆°ng tr√¨nh b√¨nh an, ch·ª© kh√¥ng ph·∫£i tai h·ªça, ƒë·ªÉ ban cho c√°c con
              m·ªôt t∆∞∆°ng lai v√† m·ªôt hy v·ªçng." - Gi√™-r√™-mi-a 29:11
            </blockquote>
            <p class="mb-4 text-gray-700 leading-relaxed">
              Nh√¢n d·ªãp n√†y, t√¥i c≈©ng mu·ªën ch√∫c m·ª´ng b·∫°n v√¨ s·ª± n·ªó l·ª±c v√† th√†nh
              c√¥ng trong c√¥ng vi·ªác t·∫°i c·ª≠a h√†ng b√°n v√© m√°y bay. C·∫ßu ch√∫c cho
              c√¥ng vi·ªác c·ªßa b·∫°n lu√¥n thƒÉng ti·∫øn, g·∫∑t h√°i ƒë∆∞·ª£c nhi·ªÅu th√†nh c√¥ng
              v√† tr·ªü th√†nh ni·ªÅm t·ª± h√†o c·ªßa gia ƒë√¨nh. Mong r·∫±ng v·ªõi s·ª± chƒÉm ch·ªâ,
              b·∫°n s·∫Ω lu√¥n g·∫∑t h√°i ƒë∆∞·ª£c nh·ªØng th√†nh t·ª±u l·ªõn h∆°n n·ªØa.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "B·∫°n h·ªØu th∆∞∆°ng m·∫øn nhau m·ªçi l√∫c; anh em sinh ra l√† ƒë·ªÉ chia s·∫ª l√∫c
              ho·∫°n n·∫°n." - Ch√¢m ng√¥n 17:17
            </blockquote>
            <p class="mb-4 text-gray-700 leading-relaxed">
              S·∫Øp t·ªõi, b·∫°n v√† B√πi Quang Minh s·∫Ω x√¢y d·ª±ng t·ªï ·∫•m. D√π ƒë√£ c√≥ ng∆∞·ªùi
              y√™u v√† s·∫Øp l·∫•y ch·ªìng, nh∆∞ng t√¨nh b·∫°n gi·ªØa ch√∫ng ta v·∫´n s·∫Ω lu√¥n b·ªÅn
              ch·∫∑t nh√©! Ch√∫c cho h√¥n nh√¢n c·ªßa b·∫°n s·∫Ω lu√¥n tr√†n ng·∫≠p ti·∫øng c∆∞·ªùi,
              s·ª± th·∫•u hi·ªÉu v√† t√¨nh y√™u th∆∞∆°ng c·ªßa Thi√™n Ch√∫a. Hy v·ªçng t√¨nh y√™u
              c·ªßa hai b·∫°n s·∫Ω lu√¥n n·ªìng n√†n nh∆∞ thu·ªü ban ƒë·∫ßu v√† c√πng nhau vi·∫øt
              n√™n m·ªôt c√¢u chuy·ªán c·ªï t√≠ch c√≥ th·∫≠t.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "Hai ng∆∞·ªùi th√¨ h∆°n m·ªôt ng∆∞·ªùi, v√¨ h·ªç c√≥ c√¥ng lao x·ª©ng ƒë√°ng v·ªõi
              nhau." - Truy·ªÅn ƒë·∫°o 4:9
            </blockquote>
            <p class="text-gray-700 leading-relaxed">
              C·∫ßu ch√∫c b·∫°n lu√¥n l√† m·ªôt ng∆∞·ªùi v·ª£ hi·ªÅn th·∫£o, m·ªôt ng∆∞·ªùi b·∫°n ƒë√°ng
              tin c·∫≠y v√† m·ªôt ng∆∞·ªùi con ngoan c·ªßa Ch√∫a. Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi
              th·∫≠t r·ª±c r·ª° v√† h·∫°nh ph√∫c, v·ªõi t·∫•t c·∫£ nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t s·∫Ω
              ƒë·∫øn.
            </p>
          </div>
          <div class="mt-6 flex flex-col items-center">
            <button
              id="tts-button"
              class="px-6 py-3 rounded-full bg-[#83c5be] text-white font-semibold shadow-lg transition-transform duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#83c5be] focus:ring-opacity-50"
            >
              üîä Nghe l·ªùi ch√∫c
            </button>
            <audio
              id="audio-player"
              controls
              autoplay
              class="mt-4 w-full max-w-sm rounded-lg shadow-md hidden"
            ></audio>
          </div>
        </section>

        <!-- Image Editing Section -->
        <section
          class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto mb-10 md:mb-16 border-l-4 border-[#006d77]"
        >
          <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-[#0b3b42]">
            T√≠nh nƒÉng Ch·ªânh s·ª≠a ·∫£nh S√°ng t·∫°o
          </h2>
          <p class="text-sm italic text-gray-600 mb-4">
            T√≠nh nƒÉng m·∫°nh m·∫Ω n√†y cho ph√©p b·∫°n th√™m ng∆∞·ªùi, ƒë·ªì v·∫≠t, ho·∫∑c c√°c chi
            ti·∫øt kh√°c v√†o b·∫•t k·ª≥ b·ª©c ·∫£nh n√†o.
          </p>
          <div class="p-4 bg-[#e2f9e4] rounded-lg shadow-inner mb-4">
            <p class="font-semibold text-lg text-[#0b3b42] mb-2">
              M·ªôt v√†i v√≠ d·ª• b·∫°n c√≥ th·ªÉ th·ª≠:
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
              <li>
                <span class="font-bold">T·∫°o ·∫£nh c·∫∑p ƒë√¥i:</span> Th√™m b·∫°n
                trai/b·∫°n g√°i c·ªßa t√¥i ƒëang ƒë·ª©ng c·∫°nh t√¥i, √¥m m·ªôt b√≥ hoa h·ªìng ƒë·ªè.
              </li>
              <li>
                <span class="font-bold">T·∫°o ·∫£nh b√°nh sinh nh·∫≠t:</span> Th√™m m·ªôt
                chi·∫øc b√°nh sinh nh·∫≠t l·ªõn v√† nhi·ªÅu m√†u s·∫Øc ·ªü trung t√¢m b·ª©c ·∫£nh.
              </li>
            </ul>
          </div>

          <div class="flex flex-col gap-4">
            <input
              id="image-upload"
              type="file"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e2f9e4] file:text-[#0b3b42] hover:file:bg-[#d4f2d7]"
              accept="image/*"
            />
            <p id="upload-error" class="text-red-500 text-sm italic hidden"></p>
            <textarea
              id="image-prompt"
              placeholder="M√¥ t·∫£ thay ƒë·ªïi b·∫°n mu·ªën th·ª±c hi·ªán tr√™n ·∫£nh..."
              class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#006d77] transition-all h-24 resize-none"
            ></textarea>
            <button
              id="generate-button"
              class="flex items-center justify-center p-3 rounded-lg bg-[#a6d6d8] text-white font-semibold transition-transform duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#a6d6d8] focus:ring-opacity-50"
            >
              ‚ú® Ch·ªânh S·ª≠a ·∫¢nh ‚ú®
            </button>
          </div>
          <div id="generated-images-container" class="mt-8"></div>
        </section>

        <!-- Video Section -->
        <section class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl md:text-4xl font-semibold mb-6 text-[#006d77]">
            Video k·ªâ ni·ªám
          </h2>
          <div class="flex justify-center">
            <div
              class="w-full p-2 bg-white rounded-2xl shadow-xl transform transition-transform duration-300 hover:scale-105"
            >
              <h3 class="text-xl font-semibold mb-2">Video c√° nh√¢n</h3>
              <div class="aspect-w-16 aspect-h-9 overflow-hidden rounded-xl">
                <video controls class="w-full h-full">
                  <source
                    src="./assets/videos/AQNHlEamVHW9tFdHyHIKSuLOuN75mjsjiw80vHWP-wQdwc_7llVUqdB4zqN_UDISVyUMiHZOC16cwiUdaD8naQ5h372OQ-Apupx6Qlobkqfg1g.mp4"
                    type="video/mp4"
                  />
                  Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video n√†y.
                </video>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Khai b√°o c√°c bi·∫øn v√† h·∫±ng s·ªë
      const RECIPIENT_NAME = "T√™r√™sa Ho√†ng Th·ªã Ki·ªÅu Trang";
      const FIANCE_NAME = "B√πi Quang Minh";
      const TARGET_BIRTHDAY_DATE = new Date("2025-09-09T09:09:00+07:00");
      const confettiColors = [
        "#f9ada0",
        "#c9c2ff",
        "#48cae4",
        "#83c5be",
        "#48cae4",
      ];
      const balloonColors = [
        "#48cae4",
        "#83c5be",
        "#a6d6d8",
        "#f9ada0",
        "#e2f9e4",
      ];
      const apiKey = typeof __app_id !== "undefined" ? "" : "DUMMY_KEY";

      // C√°c ph·∫ßn t·ª≠ DOM
      const countdownSection = document.getElementById("countdown-section");
      const birthdayContentSection = document.getElementById(
        "birthday-content-section"
      );
      const daysEl = document.getElementById("days");
      const hoursEl = document.getElementById("hours");
      const minutesEl = document.getElementById("minutes");
      const secondsEl = document.getElementById("seconds");
      const playButton = document.getElementById("play-button");
      const backgroundMusic = document.getElementById("background-music");
      const ttsButton = document.getElementById("tts-button");
      const audioPlayer = document.getElementById("audio-player");
      const imageUpload = document.getElementById("image-upload");
      const imagePrompt = document.getElementById("image-prompt");
      const generateButton = document.getElementById("generate-button");
      const generatedImagesContainer = document.getElementById(
        "generated-images-container"
      );
      const uploadErrorEl = document.getElementById("upload-error");
      const balloonsContainer = document.getElementById("balloons-container");
      const confettiContainer = document.getElementById("confetti-container");

      let isPlaying = false;
      let isTimeUp = false;
      let isLoadingImage = false;
      let isSpeaking = false;

      // Firebase Initialization (MANDATORY)
      let app, auth, db;
      try {
        const firebaseConfig = JSON.parse(
          typeof __firebase_config !== "undefined"
            ? __firebase_config
            : JSON.stringify({
                apiKey: "AIzaSyBc4M3Pdwwas6C_EmyBfrzjQDHsiJf0VTo",
                authDomain: "my-portfolio-2af8c.firebaseapp.com",
                projectId: "my-portfolio-2af8c",
                storageBucket: "my-portfolio-2af8c.firebasestorage.app",
                messagingSenderId: "480332314483",
                appId: "1:480332314483:web:9d2fec62cb56f68ee2f706",
                measurementId: "G-8D7FLYJW8P",
              })
        );
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        async function signIn() {
          try {
            if (typeof __initial_auth_token !== "undefined") {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Firebase Auth Error:", error);
          }
        }
        signIn();
      } catch (e) {
        console.error(
          "L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase. Vui l√≤ng ch·∫°y ·ª©ng d·ª•ng n√†y trong m√¥i tr∆∞·ªùng h·ªó tr·ª£ Firebase."
        );
        console.error(e);
      }

      // Helper functions for TTS audio conversion
      const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      };

      const pcmToWav = (pcm16, sampleRate) => {
        const pcmData = pcm16.buffer;
        const len = pcmData.byteLength;
        const bitDepth = 16;
        const nChannels = 1;
        const wavData = new ArrayBuffer(44 + len);
        const view = new DataView(wavData);

        // Write WAV header
        view.setUint32(0, 0x46464952, true); // "RIFF"
        view.setUint32(4, 36 + len, true); // file size
        view.setUint32(8, 0x45564157, true); // "WAVE"
        view.setUint32(12, 0x20746d66, true); // "fmt "
        view.setUint32(16, 16, true); // size of fmt chunk
        view.setUint16(20, 1, true); // format (1 for PCM)
        view.setUint16(22, nChannels, true); // channels
        view.setUint32(24, sampleRate, true); // sample rate
        view.setUint32(28, (sampleRate * nChannels * bitDepth) / 8, true); // byte rate
        view.setUint16(32, (nChannels * bitDepth) / 8, true); // block align
        view.setUint16(34, bitDepth, true); // bit depth
        view.setUint32(36, 0x61746164, true); // "data"
        view.setUint32(40, len, true); // data size

        // Write PCM data
        const pcmView = new Uint8Array(pcmData);
        for (let i = 0; i < len; i++) {
          view.setUint8(44 + i, pcmView[i]);
        }

        return new Blob([wavData], { type: "audio/wav" });
      };

      // Function to call the TTS API and play audio
      const speakMessage = async () => {
        if (isSpeaking) return;
        isSpeaking = true;
        ttsButton.textContent = "ƒêang t·∫°o √¢m thanh...";
        ttsButton.disabled = true;

        const messageContainer = document.getElementById("birthday-message");
        const fullMessage = messageContainer.innerText;

        try {
          const payload = {
            contents: [
              {
                parts: [{ text: fullMessage.trim() }],
              },
            ],
            generationConfig: {
              responseModalities: ["AUDIO"],
              speechConfig: {
                voiceConfig: {
                  prebuiltVoiceConfig: { voiceName: "Fenrir" },
                },
              },
            },
            model: "gemini-2.5-flash-preview-tts",
          };

          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          const part = result?.candidates?.[0]?.content?.parts?.[0];
          const audioData = part?.inlineData?.data;
          const mimeType = part?.inlineData?.mimeType;

          if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const url = URL.createObjectURL(wavBlob);
            audioPlayer.src = url;
            audioPlayer.play();
            audioPlayer.classList.remove("hidden");
          } else {
            console.error("Audio generation failed:", result);
          }
        } catch (error) {
          console.error("Error generating audio:", error);
        } finally {
          isSpeaking = false;
          ttsButton.textContent = "üîä Nghe l·ªùi ch√∫c";
          ttsButton.disabled = false;
        }
      };

      // Countdown logic
      function calculateTimeLeft() {
        const difference =
          TARGET_BIRTHDAY_DATE.getTime() - new Date().getTime();
        if (difference > 0) {
          const timeLeft = {
            days: Math.floor(difference / (1000 * 60 * 60 * 24)),
            hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
            minutes: Math.floor((difference / 1000 / 60) % 60),
            seconds: Math.floor((difference / 1000) % 60),
          };
          daysEl.textContent = timeLeft.days;
          hoursEl.textContent = timeLeft.hours;
          minutesEl.textContent = timeLeft.minutes;
          secondsEl.textContent = timeLeft.seconds;
        } else {
          isTimeUp = true;
          clearInterval(timer);
          countdownSection.style.display = "none";
          birthdayContentSection.style.display = "block";
          startEffects();
        }
      }

      // Balloon & Confetti effects
      function startEffects() {
        setInterval(() => {
          const size = Math.random() * 30 + 20;
          const left = Math.random() * 100;
          const duration = Math.random() * 8 + 6;
          const delay = Math.random() * 2;
          const color =
            balloonColors[Math.floor(Math.random() * balloonColors.length)];
          const balloonEl = document.createElement("div");
          balloonEl.className = "balloon";
          balloonEl.style.cssText = `
          left: ${left}vw;
          width: ${size}px;
          height: ${size}px;
          background-color: ${color};
          animation-duration: ${duration}s;
          animation-delay: ${delay}s;
          animation-name: balloon-float;
        `;
          balloonsContainer.appendChild(balloonEl);
          setTimeout(
            () => balloonsContainer.removeChild(balloonEl),
            (duration + delay) * 1000
          );
        }, 1500);

        setInterval(() => {
          const left = Math.random() * 100;
          const color =
            confettiColors[Math.floor(Math.random() * confettiColors.length)];
          const confettiEl = document.createElement("div");
          confettiEl.className = "confetti";
          confettiEl.style.cssText = `
          left: ${left}%;
          background-color: ${color};
          animation-duration: 3s;
          animation-timing-function: linear;
          animation-name: confetti-fall;
        `;
          confettiContainer.appendChild(confettiEl);
          setTimeout(() => confettiContainer.removeChild(confettiEl), 3000);
        }, 100);
      }

      // Image editing with Gemini
      async function editImageWithGemini() {
        if (apiKey === "DUMMY_KEY") {
          generateButton.textContent =
            "T√≠nh nƒÉng ch·ªâ ho·∫°t ƒë·ªông khi xem tr∆∞·ªõc tr·ª±c tuy·∫øn!";
          setTimeout(() => {
            generateButton.textContent = "‚ú® Ch·ªânh S·ª≠a ·∫¢nh ‚ú®";
          }, 5000);
          return;
        }

        const file = imageUpload.files[0];
        const prompt = imagePrompt.value;

        if (!file || !prompt) return;

        isLoadingImage = true;
        generateButton.disabled = true;
        generateButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ƒêang x·ª≠ l√Ω ·∫£nh...`;

        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64Image = reader.result.split(";base64,")[1];
          const mimeType = reader.result
            .split(";base64,")[0]
            .replace("data:", "");

          try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
              contents: [
                {
                  parts: [
                    { text: prompt },
                    { inlineData: { mimeType, data: base64Image } },
                  ],
                },
              ],
              generationConfig: {
                responseModalities: ["TEXT", "IMAGE"],
              },
            };

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            const generatedBase64 =
              result?.candidates?.[0]?.content?.parts?.find((p) => p.inlineData)
                ?.inlineData?.data;

            if (generatedBase64) {
              const newImageDiv = document.createElement("div");
              newImageDiv.className =
                "p-4 rounded-lg bg-[#d4f2d7] flex flex-col items-center shadow-lg mb-4";
              newImageDiv.innerHTML = `
              <img src="data:image/png;base64,${generatedBase64}" alt="H√¨nh ·∫£nh ƒë√£ ch·ªânh s·ª≠a" class="rounded-lg max-w-full h-auto" />
              <p class="mt-2 text-sm text-center italic text-gray-600">
                Prompt: "${prompt}"
              </p>
            `;
              generatedImagesContainer.prepend(newImageDiv);
            } else {
              console.error("Image generation failed:", result);
            }
          } catch (error) {
            console.error("Error generating image:", error);
          } finally {
            isLoadingImage = false;
            generateButton.disabled = false;
            generateButton.innerHTML = "‚ú® Ch·ªânh S·ª≠a ·∫¢nh ‚ú®";
          }
        };
        reader.readAsDataURL(file);
      }

      // Event Listeners
      playButton.addEventListener("click", () => {
        if (isPlaying) {
          backgroundMusic.pause();
          playButton.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M6 5h-2v14h2zm4 0h-2v14h2zm4 0h-2v14h2zm4 0h-2v14h2z"/></svg>';
        } else {
          backgroundMusic.play();
          playButton.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M3 22v-20l18 10-18 10z"/></svg>';
        }
        isPlaying = !isPlaying;
      });

      ttsButton.addEventListener("click", speakMessage);
      generateButton.addEventListener("click", editImageWithGemini);

      imageUpload.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files.length > 1) {
          uploadErrorEl.textContent =
            "B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn m·ªôt ·∫£nh. H√£y s·ª≠ d·ª•ng m√¥ t·∫£ ƒë·ªÉ th√™m ng∆∞·ªùi c√≤n l·∫°i.";
          uploadErrorEl.classList.remove("hidden");
        } else {
          uploadErrorEl.classList.add("hidden");
        }
      });

      // Start the countdown
      const timer = setInterval(calculateTimeLeft, 1000);
      calculateTimeLeft();
    </script>
  </body>
</html>
