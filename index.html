<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chúc Mừng Sinh Nhật Hoàng Thị Kiều Trang!</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Pacifico&display=swap");
      body {
        font-family: "Be Vietnam Pro", sans-serif;
      }
      .countdown-bg {
        background-color: #f0f4f8;
        background-image: radial-gradient(
            circle at 15% 50%,
            #e6f0ff 0%,
            transparent 50%
          ),
          radial-gradient(circle at 85% 50%, #fff0e6 0%, transparent 50%);
        background-size: 200% 200%;
        animation: background-shift 10s ease-in-out infinite alternate;
      }
      @keyframes background-shift {
        0% {
          background-position: 0% 50%, 100% 50%;
        }
        100% {
          background-position: 100% 50%, 0% 50%;
        }
      }
      .balloon {
        position: absolute;
        bottom: -100px;
        border-radius: 50%;
        z-index: 0;
      }
      @keyframes balloon-float {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 0;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          transform: translateY(-120vh) rotate(360deg);
          opacity: 0;
        }
      }
      .confetti {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        opacity: 0;
        z-index: 20;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-100vh) rotateZ(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotateZ(720deg);
          opacity: 0.7;
        }
      }
      @keyframes pulse-glow {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(72, 202, 228, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 10px 5px rgba(72, 202, 228, 0.9);
        }
      }
      @keyframes floating {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .fade-in-down {
        animation: fade-in-down 1s ease-out;
      }
      .fade-in-up {
        animation: fade-in-up 1s ease-out;
      }
      @keyframes fade-in-down {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fade-in-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="bg-[#f5f5f5] min-h-screen">
    <!-- Countdown Section -->
    <div
      id="countdown-section"
      class="relative flex items-center justify-center min-h-screen p-4 font-sans text-[#0b3b42] overflow-hidden countdown-bg"
    >
      <div
        class="text-center p-8 bg-white rounded-3xl shadow-2xl max-w-lg w-full transform transition-all duration-500 ease-in-out hover:scale-105 relative z-10"
      >
        <div class="absolute top-[-20px] left-1/2 transform -translate-x-1/2">
          <svg
            class="w-12 h-12 text-[#f9ada0] animate-floating"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M20 9.5a2.5 2.5 0 0 0-2.5-2.5h-11A2.5 2.5 0 0 0 4 9.5v10a2.5 2.5 0 0 0 2.5 2.5h11a2.5 2.5 0 0 0 2.5-2.5zM12 2a2 2 0 0 1 2 2v2H10V4a2 2 0 0 1 2-2zM9 9h6a1 1 0 0 1 0 2H9a1 1 0 0 1 0-2zM4 14.5a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V15a.5.5 0 0 1 .5-.5zM20 15a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V15a.5.5 0 0 1 .5-.5z"
            />
          </svg>
        </div>
        <h1
          class="text-3xl md:text-4xl font-bold text-[#006d77] mb-4 relative z-10"
        >
          Một bất ngờ đang chờ...
        </h1>
        <p
          class="text-lg md:text-xl font-light italic mb-8 text-gray-600 relative z-10"
        >
          Hãy cùng đếm ngược đến khoảnh khắc đặc biệt nhé!
        </p>
        <div
          id="countdown-container"
          class="grid grid-cols-2 sm:grid-cols-4 gap-4 md:gap-6 text-center"
        >
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="days"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Ngày
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="hours"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Giờ
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="minutes"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Phút
            </p>
          </div>
          <div
            class="flex flex-col items-center justify-center p-4 bg-[#e2f9e4] rounded-xl shadow-inner animate-pulse-glow"
          >
            <p
              id="seconds"
              class="text-4xl md:text-6xl font-extrabold text-[#48cae4]"
            >
              0
            </p>
            <p
              class="text-xs md:text-sm font-semibold uppercase text-gray-700 mt-1"
            >
              Giây
            </p>
          </div>
        </div>
        <p class="mt-8 text-sm md:text-md text-gray-500 italic relative z-10">
          Gợi ý: Hãy quay lại đúng 09:09 ngày 09/09/2025 để khám phá!
        </p>
      </div>
    </div>

    <!-- Birthday Content Section (hidden initially) -->
    <div
      id="birthday-content-section"
      class="relative min-h-screen font-sans text-[#0b3b42] overflow-hidden"
      style="display: none"
    >
      <div id="balloons-container"></div>
      <div id="confetti-container"></div>

      <div class="relative z-10 p-4 md:p-8 lg:p-12">
        <header class="text-center mb-10 md:mb-16">
          <h1
            class="text-4xl md:text-6xl font-bold text-[#006d77] leading-tight animate-fade-in-down"
          >
            Chúc mừng sinh nhật,<br />Têrêsa Hoàng Thị Kiều Trang!
          </h1>
          <p
            class="text-lg md:text-xl mt-2 italic text-[#83c5be] font-light animate-fade-in-up"
          >
            2002 - 09/09 - 2025
          </p>
          <div class="flex justify-center items-center my-6 animate-fade-in-up">
            <img
              src="./assets/images/170cc1c4-0d04-4637-b98c-7e063ab187c0.jpg"
              alt="Ảnh đại diện của Têrêsa"
              class="w-40 h-40 rounded-full object-cover shadow-xl border-4 border-white transform transition-transform duration-300 hover:scale-110"
            />
          </div>
          <div class="mt-6">
            <p class="text-3xl font-bold text-[#48cae4]">
              Tuổi 18+ rạng rỡ và mãi tươi vui!
            </p>
          </div>
          <button
            id="play-button"
            class="mt-6 p-4 rounded-full bg-[#48cae4] text-white shadow-lg transition-transform duration-300 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-[#48cae4] focus:ring-opacity-50"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              class="w-6 h-6"
            >
              <path d="M3 22v-20l18 10-18 10z" />
            </svg>
          </button>
          <audio
            id="background-music"
            src="./assets/audios/videoplayback.m4a"
            loop
          ></audio>
        </header>

        <section
          id="message-container"
          class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto mb-10 md:mb-16 border-l-4 border-[#f9ada0]"
        >
          <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-[#0b3b42]">
            Gửi cô bạn thân mến của tôi...
          </h2>
          <div id="birthday-message">
            <p class="mb-4 text-gray-700 leading-relaxed">
              Chúc mừng sinh nhật, cô bạn bánh bèo nhưng giàu tình cảm của tôi!
              Hôm nay là một ngày thật đặc biệt, ngày mà Chúa đã ban cho thế
              giới một người bạn tuyệt vời như bạn. Dù là bạn bè, tôi cũng muốn
              gửi đến bạn những lời chúc tốt đẹp nhất cho một trang mới của cuộc
              đời. Chúc bạn một tuổi mới tràn ngập niềm vui, tiếng cười và những
              trải nghiệm thật đáng nhớ.
            </p>
            <p class="mb-4 text-gray-700 leading-relaxed">
              Chúc bạn luôn tràn đầy sức khỏe, để tiếp tục cuộc hành trình sống
              động và đầy ý nghĩa của mình. Nguyện xin Chúa luôn gìn giữ, che
              chở và soi sáng cho bạn trong mọi quyết định, để mọi công việc bạn
              làm đều được hồng ân của Ngài.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "Vì Ta biết rõ những chương trình Ta dành cho các con, đó là
              chương trình bình an, chứ không phải tai họa, để ban cho các con
              một tương lai và một hy vọng." - Giê-rê-mi-a 29:11
            </blockquote>
            <p class="mb-4 text-gray-700 leading-relaxed">
              Nhân dịp này, tôi cũng muốn chúc mừng bạn vì sự nỗ lực và thành
              công trong công việc tại cửa hàng bán vé máy bay. Cầu chúc cho
              công việc của bạn luôn thăng tiến, gặt hái được nhiều thành công
              và trở thành niềm tự hào của gia đình. Mong rằng với sự chăm chỉ,
              bạn sẽ luôn gặt hái được những thành tựu lớn hơn nữa.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "Bạn hữu thương mến nhau mọi lúc; anh em sinh ra là để chia sẻ lúc
              hoạn nạn." - Châm ngôn 17:17
            </blockquote>
            <p class="mb-4 text-gray-700 leading-relaxed">
              Sắp tới, bạn và Bùi Quang Minh sẽ xây dựng tổ ấm. Dù đã có người
              yêu và sắp lấy chồng, nhưng tình bạn giữa chúng ta vẫn sẽ luôn bền
              chặt nhé! Chúc cho hôn nhân của bạn sẽ luôn tràn ngập tiếng cười,
              sự thấu hiểu và tình yêu thương của Thiên Chúa. Hy vọng tình yêu
              của hai bạn sẽ luôn nồng nàn như thuở ban đầu và cùng nhau viết
              nên một câu chuyện cổ tích có thật.
            </p>
            <blockquote
              class="italic border-l-4 border-l-[#48cae4] pl-4 my-4 text-gray-600"
            >
              "Hai người thì hơn một người, vì họ có công lao xứng đáng với
              nhau." - Truyền đạo 4:9
            </blockquote>
            <p class="text-gray-700 leading-relaxed">
              Cầu chúc bạn luôn là một người vợ hiền thảo, một người bạn đáng
              tin cậy và một người con ngoan của Chúa. Chúc bạn một tuổi mới
              thật rực rỡ và hạnh phúc, với tất cả những điều tốt đẹp nhất sẽ
              đến.
            </p>
          </div>
          <div class="mt-6 flex flex-col items-center">
            <button
              id="tts-button"
              class="px-6 py-3 rounded-full bg-[#83c5be] text-white font-semibold shadow-lg transition-transform duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#83c5be] focus:ring-opacity-50"
            >
              🔊 Nghe lời chúc
            </button>
            <audio
              id="audio-player"
              controls
              autoplay
              class="mt-4 w-full max-w-sm rounded-lg shadow-md hidden"
            ></audio>
          </div>
        </section>

        <!-- Image Editing Section -->
        <section
          class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto mb-10 md:mb-16 border-l-4 border-[#006d77]"
        >
          <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-[#0b3b42]">
            Tính năng Chỉnh sửa ảnh Sáng tạo
          </h2>
          <p class="text-sm italic text-gray-600 mb-4">
            Tính năng mạnh mẽ này cho phép bạn thêm người, đồ vật, hoặc các chi
            tiết khác vào bất kỳ bức ảnh nào.
          </p>
          <div class="p-4 bg-[#e2f9e4] rounded-lg shadow-inner mb-4">
            <p class="font-semibold text-lg text-[#0b3b42] mb-2">
              Một vài ví dụ bạn có thể thử:
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
              <li>
                <span class="font-bold">Tạo ảnh cặp đôi:</span> Thêm bạn
                trai/bạn gái của tôi đang đứng cạnh tôi, ôm một bó hoa hồng đỏ.
              </li>
              <li>
                <span class="font-bold">Tạo ảnh bánh sinh nhật:</span> Thêm một
                chiếc bánh sinh nhật lớn và nhiều màu sắc ở trung tâm bức ảnh.
              </li>
            </ul>
          </div>

          <div class="flex flex-col gap-4">
            <input
              id="image-upload"
              type="file"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e2f9e4] file:text-[#0b3b42] hover:file:bg-[#d4f2d7]"
              accept="image/*"
            />
            <p id="upload-error" class="text-red-500 text-sm italic hidden"></p>
            <textarea
              id="image-prompt"
              placeholder="Mô tả thay đổi bạn muốn thực hiện trên ảnh..."
              class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#006d77] transition-all h-24 resize-none"
            ></textarea>
            <button
              id="generate-button"
              class="flex items-center justify-center p-3 rounded-lg bg-[#a6d6d8] text-white font-semibold transition-transform duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#a6d6d8] focus:ring-opacity-50"
            >
              ✨ Chỉnh Sửa Ảnh ✨
            </button>
          </div>
          <div id="generated-images-container" class="mt-8"></div>
        </section>

        <!-- Video Section -->
        <section class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl md:text-4xl font-semibold mb-6 text-[#006d77]">
            Video kỉ niệm
          </h2>
          <div class="flex justify-center">
            <div
              class="w-full p-2 bg-white rounded-2xl shadow-xl transform transition-transform duration-300 hover:scale-105"
            >
              <h3 class="text-xl font-semibold mb-2">Video cá nhân</h3>
              <div class="aspect-w-16 aspect-h-9 overflow-hidden rounded-xl">
                <video controls class="w-full h-full">
                  <source
                    src="./assets/videos/AQNHlEamVHW9tFdHyHIKSuLOuN75mjsjiw80vHWP-wQdwc_7llVUqdB4zqN_UDISVyUMiHZOC16cwiUdaD8naQ5h372OQ-Apupx6Qlobkqfg1g.mp4"
                    type="video/mp4"
                  />
                  Trình duyệt của bạn không hỗ trợ video này.
                </video>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Khai báo các biến và hằng số
      const RECIPIENT_NAME = "Têrêsa Hoàng Thị Kiều Trang";
      const FIANCE_NAME = "Bùi Quang Minh";
      const TARGET_BIRTHDAY_DATE = new Date("2025-09-09T09:09:00+07:00");
      const confettiColors = [
        "#f9ada0",
        "#c9c2ff",
        "#48cae4",
        "#83c5be",
        "#48cae4",
      ];
      const balloonColors = [
        "#48cae4",
        "#83c5be",
        "#a6d6d8",
        "#f9ada0",
        "#e2f9e4",
      ];
      const apiKey = typeof __app_id !== "undefined" ? "" : "DUMMY_KEY";

      // Các phần tử DOM
      const countdownSection = document.getElementById("countdown-section");
      const birthdayContentSection = document.getElementById(
        "birthday-content-section"
      );
      const daysEl = document.getElementById("days");
      const hoursEl = document.getElementById("hours");
      const minutesEl = document.getElementById("minutes");
      const secondsEl = document.getElementById("seconds");
      const playButton = document.getElementById("play-button");
      const backgroundMusic = document.getElementById("background-music");
      const ttsButton = document.getElementById("tts-button");
      const audioPlayer = document.getElementById("audio-player");
      const imageUpload = document.getElementById("image-upload");
      const imagePrompt = document.getElementById("image-prompt");
      const generateButton = document.getElementById("generate-button");
      const generatedImagesContainer = document.getElementById(
        "generated-images-container"
      );
      const uploadErrorEl = document.getElementById("upload-error");
      const balloonsContainer = document.getElementById("balloons-container");
      const confettiContainer = document.getElementById("confetti-container");

      let isPlaying = false;
      let isTimeUp = false;
      let isLoadingImage = false;
      let isSpeaking = false;

      // Firebase Initialization (MANDATORY)
      let app, auth, db;
      try {
        const firebaseConfig = JSON.parse(
          typeof __firebase_config !== "undefined"
            ? __firebase_config
            : JSON.stringify({
                apiKey: "AIzaSyBc4M3Pdwwas6C_EmyBfrzjQDHsiJf0VTo",
                authDomain: "my-portfolio-2af8c.firebaseapp.com",
                projectId: "my-portfolio-2af8c",
                storageBucket: "my-portfolio-2af8c.firebasestorage.app",
                messagingSenderId: "480332314483",
                appId: "1:480332314483:web:9d2fec62cb56f68ee2f706",
                measurementId: "G-8D7FLYJW8P",
              })
        );
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        async function signIn() {
          try {
            if (typeof __initial_auth_token !== "undefined") {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Firebase Auth Error:", error);
          }
        }
        signIn();
      } catch (e) {
        console.error(
          "Lỗi: Không thể khởi tạo Firebase. Vui lòng chạy ứng dụng này trong môi trường hỗ trợ Firebase."
        );
        console.error(e);
      }

      // Helper functions for TTS audio conversion
      const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      };

      const pcmToWav = (pcm16, sampleRate) => {
        const pcmData = pcm16.buffer;
        const len = pcmData.byteLength;
        const bitDepth = 16;
        const nChannels = 1;
        const wavData = new ArrayBuffer(44 + len);
        const view = new DataView(wavData);

        // Write WAV header
        view.setUint32(0, 0x46464952, true); // "RIFF"
        view.setUint32(4, 36 + len, true); // file size
        view.setUint32(8, 0x45564157, true); // "WAVE"
        view.setUint32(12, 0x20746d66, true); // "fmt "
        view.setUint32(16, 16, true); // size of fmt chunk
        view.setUint16(20, 1, true); // format (1 for PCM)
        view.setUint16(22, nChannels, true); // channels
        view.setUint32(24, sampleRate, true); // sample rate
        view.setUint32(28, (sampleRate * nChannels * bitDepth) / 8, true); // byte rate
        view.setUint16(32, (nChannels * bitDepth) / 8, true); // block align
        view.setUint16(34, bitDepth, true); // bit depth
        view.setUint32(36, 0x61746164, true); // "data"
        view.setUint32(40, len, true); // data size

        // Write PCM data
        const pcmView = new Uint8Array(pcmData);
        for (let i = 0; i < len; i++) {
          view.setUint8(44 + i, pcmView[i]);
        }

        return new Blob([wavData], { type: "audio/wav" });
      };

      // Function to call the TTS API and play audio
      const speakMessage = async () => {
        if (isSpeaking) return;
        isSpeaking = true;
        ttsButton.textContent = "Đang tạo âm thanh...";
        ttsButton.disabled = true;

        const messageContainer = document.getElementById("birthday-message");
        const fullMessage = messageContainer.innerText;

        try {
          const payload = {
            contents: [
              {
                parts: [{ text: fullMessage.trim() }],
              },
            ],
            generationConfig: {
              responseModalities: ["AUDIO"],
              speechConfig: {
                voiceConfig: {
                  prebuiltVoiceConfig: { voiceName: "Fenrir" },
                },
              },
            },
            model: "gemini-2.5-flash-preview-tts",
          };

          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          const part = result?.candidates?.[0]?.content?.parts?.[0];
          const audioData = part?.inlineData?.data;
          const mimeType = part?.inlineData?.mimeType;

          if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const url = URL.createObjectURL(wavBlob);
            audioPlayer.src = url;
            audioPlayer.play();
            audioPlayer.classList.remove("hidden");
          } else {
            console.error("Audio generation failed:", result);
          }
        } catch (error) {
          console.error("Error generating audio:", error);
        } finally {
          isSpeaking = false;
          ttsButton.textContent = "🔊 Nghe lời chúc";
          ttsButton.disabled = false;
        }
      };

      // Countdown logic
      function calculateTimeLeft() {
        const difference =
          TARGET_BIRTHDAY_DATE.getTime() - new Date().getTime();
        if (difference > 0) {
          const timeLeft = {
            days: Math.floor(difference / (1000 * 60 * 60 * 24)),
            hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
            minutes: Math.floor((difference / 1000 / 60) % 60),
            seconds: Math.floor((difference / 1000) % 60),
          };
          daysEl.textContent = timeLeft.days;
          hoursEl.textContent = timeLeft.hours;
          minutesEl.textContent = timeLeft.minutes;
          secondsEl.textContent = timeLeft.seconds;
        } else {
          isTimeUp = true;
          clearInterval(timer);
          countdownSection.style.display = "none";
          birthdayContentSection.style.display = "block";
          startEffects();
        }
      }

      // Balloon & Confetti effects
      function startEffects() {
        setInterval(() => {
          const size = Math.random() * 30 + 20;
          const left = Math.random() * 100;
          const duration = Math.random() * 8 + 6;
          const delay = Math.random() * 2;
          const color =
            balloonColors[Math.floor(Math.random() * balloonColors.length)];
          const balloonEl = document.createElement("div");
          balloonEl.className = "balloon";
          balloonEl.style.cssText = `
          left: ${left}vw;
          width: ${size}px;
          height: ${size}px;
          background-color: ${color};
          animation-duration: ${duration}s;
          animation-delay: ${delay}s;
          animation-name: balloon-float;
        `;
          balloonsContainer.appendChild(balloonEl);
          setTimeout(
            () => balloonsContainer.removeChild(balloonEl),
            (duration + delay) * 1000
          );
        }, 1500);

        setInterval(() => {
          const left = Math.random() * 100;
          const color =
            confettiColors[Math.floor(Math.random() * confettiColors.length)];
          const confettiEl = document.createElement("div");
          confettiEl.className = "confetti";
          confettiEl.style.cssText = `
          left: ${left}%;
          background-color: ${color};
          animation-duration: 3s;
          animation-timing-function: linear;
          animation-name: confetti-fall;
        `;
          confettiContainer.appendChild(confettiEl);
          setTimeout(() => confettiContainer.removeChild(confettiEl), 3000);
        }, 100);
      }

      // Image editing with Gemini
      async function editImageWithGemini() {
        if (apiKey === "DUMMY_KEY") {
          generateButton.textContent =
            "Tính năng chỉ hoạt động khi xem trước trực tuyến!";
          setTimeout(() => {
            generateButton.textContent = "✨ Chỉnh Sửa Ảnh ✨";
          }, 5000);
          return;
        }

        const file = imageUpload.files[0];
        const prompt = imagePrompt.value;

        if (!file || !prompt) return;

        isLoadingImage = true;
        generateButton.disabled = true;
        generateButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Đang xử lý ảnh...`;

        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64Image = reader.result.split(";base64,")[1];
          const mimeType = reader.result
            .split(";base64,")[0]
            .replace("data:", "");

          try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
              contents: [
                {
                  parts: [
                    { text: prompt },
                    { inlineData: { mimeType, data: base64Image } },
                  ],
                },
              ],
              generationConfig: {
                responseModalities: ["TEXT", "IMAGE"],
              },
            };

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            const generatedBase64 =
              result?.candidates?.[0]?.content?.parts?.find((p) => p.inlineData)
                ?.inlineData?.data;

            if (generatedBase64) {
              const newImageDiv = document.createElement("div");
              newImageDiv.className =
                "p-4 rounded-lg bg-[#d4f2d7] flex flex-col items-center shadow-lg mb-4";
              newImageDiv.innerHTML = `
              <img src="data:image/png;base64,${generatedBase64}" alt="Hình ảnh đã chỉnh sửa" class="rounded-lg max-w-full h-auto" />
              <p class="mt-2 text-sm text-center italic text-gray-600">
                Prompt: "${prompt}"
              </p>
            `;
              generatedImagesContainer.prepend(newImageDiv);
            } else {
              console.error("Image generation failed:", result);
            }
          } catch (error) {
            console.error("Error generating image:", error);
          } finally {
            isLoadingImage = false;
            generateButton.disabled = false;
            generateButton.innerHTML = "✨ Chỉnh Sửa Ảnh ✨";
          }
        };
        reader.readAsDataURL(file);
      }

      // Event Listeners
      playButton.addEventListener("click", () => {
        if (isPlaying) {
          backgroundMusic.pause();
          playButton.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M6 5h-2v14h2zm4 0h-2v14h2zm4 0h-2v14h2zm4 0h-2v14h2z"/></svg>';
        } else {
          backgroundMusic.play();
          playButton.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M3 22v-20l18 10-18 10z"/></svg>';
        }
        isPlaying = !isPlaying;
      });

      ttsButton.addEventListener("click", speakMessage);
      generateButton.addEventListener("click", editImageWithGemini);

      imageUpload.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files.length > 1) {
          uploadErrorEl.textContent =
            "Bạn chỉ có thể chọn một ảnh. Hãy sử dụng mô tả để thêm người còn lại.";
          uploadErrorEl.classList.remove("hidden");
        } else {
          uploadErrorEl.classList.add("hidden");
        }
      });

      // Start the countdown
      const timer = setInterval(calculateTimeLeft, 1000);
      calculateTimeLeft();
    </script>
  </body>
</html>
